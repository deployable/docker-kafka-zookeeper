#!/bin/bash

set -ue

KAFKA_PORT=${KAFKA_PORT:-9092}
ZK_PORT=${ZK_PORT:-2181}

request_v0_11="0000000e001200000000000000046d656565"
expected_v0_11="000000d60000000000000000002200000000000300010000000500020000
000200030000000400040000000000050000000000060000000300070001
0001000800000003000900000003000a00000001000b00000002000c0000
0001000d00000001000e00000001000f0000000100100000000100110000
000000120000000100130000000200140000000100150000000000160000
0000001700000000001800000000001900000000001a00000000001b0000
0000001c00000000001d00000000001e00000000001f0000000000200000
0000002100000000"


expected_v1_1="0000010c0000000000000000002b00000000000500010000000700020000
000200030000000500040000000100050000000000060000000400070000
0001000800000003000900000003000a00000001000b00000002000c0000
0001000d00000001000e00000001000f0000000100100000000100110000
000100120000000100130000000200140000000100150000000000160000
0000001700000000001800000000001900000000001a00000000001b0000
0000001c00000000001d00000000001e00000000001f0000000000200000
000100210000000000220000000000230000000000240000000000250000
0000002600000000002700000000002800000000002900000000002a0000
0000"

request_v2_1="0000000e001200000000000100046d656565"
expected_v2_1="0000010c0000000100000000002b00000000000700010000000a00020000
000400030000000700040000000100050000000000060000000400070000
0001000800000006000900000005000a00000002000b00000003000c0000
0002000d00000002000e00000002000f0000000200100000000200110000
000100120000000200130000000300140000000300150000000100160000
0001001700000002001800000001001900000001001a00000001001b0000
0000001c00000002001d00000001001e00000001001f0000000100200000
000200210000000100220000000100230000000100240000000000250000
0001002600000001002700000001002800000001002900000001002a0000
0001"

if [ "$1" == "kafka" ]; then 
  #res=$(echo "$request_v2_1" | xxd -r -p | nc localhost $KAFKA_PORT | xxd -l 218 -p)
  res=$(echo '0000000e001200000000000100046d656565' | xxd -r -p | nc -c localhost $KAFKA_PORT | xxd -l 218 -p)
  rc=$?
  if [ "$res" != "$expected_v2_1" ]; then 
    # kafka doesn't have a text interface,
    echo "Bad result: $res"
    echo "rc was: $rc"
    exit 1
  fi
fi

if [ "$1" == "zookeeper" ]; then
  res=$(echo ruok | nc localhost $ZK_PORT)
  rc=$?
  if [ "$res" != "imok" ]; then
    echo "Bad result: $res"
    echo "$rc"
    exit 1
  fi
fi

